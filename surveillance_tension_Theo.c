#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include "surveillance_tension.h"
#include "Read_Write.h"

// ============================================================================
// Fonction principale : surveillance tension
// ============================================================================
void surveillance_tension(float courant,
                          float SOC,
                          float tension_mesuree,
                          int etat,  // 1=decharge, 0=charge
                          const float *X_OCV,
                          const float *Y_OCV_charge,
                          const float *Y_OCV_decharge,
                          int n_OCV,
                          float dt,
                          float R1,
                          float C1,
                          float R0,
                          float seuil_alerte,
                          float *Ir,
                          float *U,
                          int   *alerte)
{
    // Saturation SOC
    if (SOC < 0.0f) SOC = 0.0f;
    if (SOC > 1.0f) SOC = 1.0f;

    // Filtre RC : Ir(k+1) = (-dt/(R1*C1)+1)*Ir(k) + (dt/(R1*C1))*courant(k)
    float denom = R1 * C1;
    if (denom != 0.0f) {
        float alpha = -dt / denom + 1.0f;
        float beta  =  dt / denom;
        *Ir = alpha * (*Ir) + beta * courant;
    }

    // Sélection de la table OCV charge / décharge
    const float *Y_tab = etat ? Y_OCV_decharge : Y_OCV_charge;

    // Interpolation OCV(SOC)
    float OCV = interp1Drapide(X_OCV, Y_tab, n_OCV, SOC);

    // Tension modèle : U = OCV - R1*Ir - R0*courant
    float U_loc = OCV - R1 * (*Ir) - R0 * courant;
    *U = U_loc;

    // Calcul de l’alerte
    float diff = fabsf(tension_mesuree - U_loc);
    *alerte = (diff > seuil_alerte) ? 1 : 0;
}

// ============================================================================
// setup
// ============================================================================
void TENSION_setup(void)
{
    const float *courant = NULL;
    const float *tension = NULL;
    const float *temperature = NULL;
    const float *SOH = NULL;
    const float *SOC_simu = NULL;

    const int NbIteration = 1000000;

    float *vecteur_U = malloc(NbIteration * sizeof(float));
    float *vecteur_alerte = malloc(NbIteration * sizeof(float));

    if (!vecteur_U || !vecteur_alerte) {
        perror("Erreur allocation mémoire");
        return;
    }

    float dt = 1.0f;
    float R1 = 0.0130f;
    float C1 = 653.6309f;
    float R0 = 0.0185f;
    float seuil = 1.0f;

    float Ir = 0.0f;

    // Chargement des données
    Charge_donnees(&courant, &tension, &temperature, &SOH, &SOC_simu);

    // Tables OCV globales
    const float X_OCV_global[104] = {0,0.0130000000000000,0.0200000000000000,0.0300000000000000,0.0400000000000000,0.0500000000000000,0.0600000000000000,0.0700000000000000,0.0800000000000000,0.0900000000000000,0.100000000000000,0.110000000000000,0.120000000000000,0.130000000000000,0.140000000000000,0.150000000000000,0.160000000000000,0.170000000000000,0.180000000000000,0.190000000000000,0.200000000000000,0.210000000000000,0.220000000000000,0.230000000000000,0.240000000000000,0.250000000000000,0.260000000000000,0.270000000000000,0.280000000000000,0.290000000000000,0.300000000000000,0.310000000000000,0.320000000000000,0.330000000000000,0.340000000000000,0.350000000000000,0.360000000000000,0.370000000000000,0.380000000000000,0.390000000000000,0.400000000000000,0.410000000000000,0.420000000000000,0.430000000000000,0.440000000000000,0.450000000000000,0.460000000000000,0.470000000000000,0.480000000000000,0.490000000000000,0.500000000000000,0.510000000000000,0.520000000000000,0.530000000000000,0.540000000000000,0.550000000000000,0.560000000000000,0.570000000000000,0.580000000000000,0.590000000000000,0.600000000000000,0.610000000000000,0.620000000000000,0.630000000000000,0.640000000000000,0.650000000000000,0.660000000000000,0.670000000000000,0.680000000000000,0.690000000000000,0.700000000000000,0.710000000000000,0.720000000000000,0.730000000000000,0.740000000000000,0.750000000000000,0.760000000000000,0.770000000000000,0.780000000000000,0.790000000000000,0.800000000000000,0.810000000000000,0.820000000000000,0.830000000000000,0.840000000000000,0.850000000000000,0.860000000000000,0.870000000000000,0.880000000000000,0.890000000000000,0.900000000000000,0.910000000000000,0.920000000000000,0.930000000000000,0.940000000000000,0.950000000000000,0.960000000000000,0.970000000000000,0.975000000000000,0.980000000000000,0.981000000000000,0.990000000000000,0.998000000000000,1};
    const float Y_OCV_charge_global[104] = {1.93320591726383,2.72927689206185,2.90579645200208,3.00890396427491,3.07314720547136,3.11994404430914,3.15631628473196,3.18461555089513,3.19862507170108,3.20383713313319,3.20824882411017,3.21269456691443,3.21714034436255,3.22165971951479,3.22634503157115,3.23117710353971,3.23636968920874,3.24178559520144,3.24727841889090,3.25252829362149,3.25744072446765,3.26201293905091,3.26648347213677,3.27076118926300,3.27486302356911,3.27866044384303,3.28206931932081,3.28522106647712,3.28786245101716,3.28990444055481,3.29135221282127,3.29242416702706,3.29322858316110,3.29394306645515,3.29465352546244,3.29527598426274,3.29598002881645,3.29669947534544,3.29743181451133,3.29813583022576,3.29889143745328,3.29965995594409,3.30046866978401,3.30126035791275,3.30209115029187,3.30298911679326,3.30387401646223,3.30484876343021,3.30578480030980,3.30679582162608,3.30783309282112,3.30894126676893,3.31002530578505,3.31115573531053,3.31236088067647,3.31348175916181,3.31473477863585,3.31588263902942,3.31705414055541,3.31823515589686,3.31928359702935,3.32032820009582,3.32133647434333,3.32226864288061,3.32321816673583,3.32413755530206,3.32509635363440,3.32603888935008,3.32703124977341,3.32802253558441,3.32906834883069,3.33016807121581,3.33135129550589,3.33250771540512,3.33374297786771,3.33494255368588,3.33614783126952,3.33744675268993,3.33868458101741,3.34005776898489,3.34139450195969,3.34275947999335,3.34419913746802,3.34561634879700,3.34711224474104,3.34878243984805,3.35043112551439,3.35230276052083,3.35436909985468,3.35666890175434,3.35938840428328,3.36263150847403,3.36667581306981,3.37211301148895,3.37968783363469,3.39091131517125,3.40909519974270,3.44378616210367,3.47535641092084,3.52545595144802,3.53771892347285,3.57872958167729,3.59765701361933,3.59767808758804};
    const float Y_OCV_decharge_global[104] = {2.17810726521397,2.64619885228218,2.74779038224984,2.84220326941330,2.90907808281774,2.96003300726194,3.00002764677570,3.03173972664926,3.05703202409312,3.07714439136274,3.09342646528549,3.10669722619243,3.11781916418998,3.12733211365986,3.13573778519909,3.14322508606925,3.15000996853790,3.15618873540485,3.16191568251172,3.16720046276118,3.17201621695117,3.17655777655872,3.18077301979361,3.18466000207268,3.18831930305334,3.19170321461967,3.19494109336420,3.19797311646528,3.20082089765752,3.20358137134503,3.20628617948389,3.20881527327443,3.21134027164807,3.21377917232735,3.21622271645205,3.21862503928664,3.22103664159122,3.22343893834968,3.22584469241097,3.22824823750213,3.23061081113556,3.23295223806204,3.23534871980090,3.23759913447216,3.23994447093429,3.24225186714112,3.24440884775619,3.24664525008857,3.24884964562732,3.25099169367741,3.25309552824769,3.25521488994224,3.25727226291227,3.25930097400990,3.26131973419157,3.26323853558761,3.26517658596839,3.26712241006934,3.26897736902661,3.27078522791041,3.27258568136030,3.27441186129856,3.27618634300700,3.27794268776836,3.27970139500087,3.28141275249602,3.28316141447282,3.28484626230925,3.28651341679660,3.28821625301702,3.28979974744345,3.29142621817904,3.29294886371251,3.29444861570200,3.29600873750741,3.29748116965315,3.29895959752347,3.30036366025858,3.30178411818127,3.30322004214205,3.30458996161796,3.30604529164250,3.30742439296035,3.30878167152838,3.31019335279497,3.31154547438990,3.31292540758604,3.31436748604800,3.31586685661157,3.31729803615602,3.31877306915676,3.32042327196300,3.32204905990387,3.32379772541427,3.32570573356999,3.32776400223940,3.33034810161321,3.33433271623742,3.33790923926188,3.34437324998017,3.34629999118907,3.38101846324182,3.46955240362839,3.77810770618289};
    const int N_OCV = 104;

     // === Variables pour la détection charge/décharge (équivalent MATLAB) ===
    // etat = 0 --> charge, etat = 1 --> décharge
    int etat = 0;
    int etat_precedent = 0;
    float tampon_charge_decharge[60] = {0.0f};

    for (int i = 0; i < NbIteration; ++i)
    {
        float U_model = 0.0f;
        int alerte = 0;

        // Même convention que dans script_principal.m : courant_simulation = -courant
        float courant_simulation = -courant[i];

        // === Détection de la phase charge/décharge ===
        detection_charge_decharge(
            courant_simulation,
            tampon_charge_decharge,
            &etat,
            &etat_precedent
        );

        // === Modèle de tension ===
        surveillance_tension(
            courant_simulation,
            SOC_simu[i],
            tension[i],
            etat, // 0 = charge, 1 = décharge
            X_OCV_global,
            Y_OCV_charge_global,
            Y_OCV_decharge_global,
            N_OCV,
            dt,
            R1,
            C1,
            R0,
            seuil,
            &Ir,
            &U_model,
            &alerte
        );

        vecteur_U[i]      = U_model;
        vecteur_alerte[i] = (float)alerte;
    }

    // === ÉCRITURE DES RÉSULTATS ===
    Ecriture_result(vecteur_U, NbIteration, "TENSION_MODEL_raspi_result2");
    Ecriture_result(vecteur_alerte, NbIteration, "ALERTE_TENSION_raspi_result");

    Free_donnees(courant, tension, temperature, SOH, SOC_simu);

    free(vecteur_U);
    free(vecteur_alerte);
}

/*
int main()
{
    TENSION_setup();
    printf("Fin du programme !\n");
    return 0;
}*/
