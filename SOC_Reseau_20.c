#include "SOC_Aurore.h"

#define max(a,b) ((a) > (b) ? (a) : (b))
#define min(a,b) ((a) < (b) ? (a) : (b))

void setup() {

  // dimension du LSTM
  const int tailleEntree = 3;
  const int tailleReseau = 20;
  const int tailleSortie = 1;

  // entrées & états
  float courant = 3;
  float tension = 3.05;
  float temperature = 35;
  float SOH = 1;
  float SOC = 0.1136;

// Aurore : taille des tableaux enlever. Inutile si la taille ne change pas et cause des erreurs

// Aurore : Pourquoi xt est initialisé ?

float xt[] = {9.4559 , 4.2866 , -13.2461 };
float ht[] = {6.4638 , -13.892 , -13.4068 , 11.2887 , 0.016961 , 3.7968 , -9.0133 , -1.9679 , 3.0694 , 1.6746 , 17.8808 , -6.2408 }; 
float ct[] = {-1.4996 , 8.3222 , 9.4809 , -19.7374 , -3.9188 , -6.7671 , -0.16021 , 5.1517 , 4.4483 , 11.409 , 4.4768 , 3.1544 }; 
const float Wi[] = {
-0.0013864826, -0.0062211026, 0.028899601,
-0.034216348, 0.016249107, 0.0082352981,
-0.017262992, -0.026258819, -0.021888761,
0.026080182, -0.033874288, -0.027821528,
0.013705736, -0.019075816, -0.0081324875,
-0.11093795, 0.047589920, 0.040971465,
0.010036851, -0.029377056, 0.012180340,
-0.062342536, 0.027823940, -0.063649774,
0.056758422, -0.020777594, -0.058653843,
-0.0011184115, 0.010122604, 0.0077513885,
-0.025817389, 0.0069514485, -0.00050656381,
0.062905341, -0.060380209, 0.013519747,
-0.029200895, 0.046324968, -0.077246420,
0.076306075, -0.0035868469, 0.027114836,
0.036865570, -0.0069207884, -0.057449546,
-0.058017172, 0.019747764, 0.00081198639,
0.017188998, -0.028647775, 0.011704437,
0.0027979510, -0.0093269739, -0.0015458546,
-0.021795042, -0.045927200, 0.050816488,
0.0048363949, -0.028298687, -0.0078725629
};
const float Wf[] = {
-0.00069749152, -0.0067451010, 0.042119496,
-0.051892355, 0.073635213, 0.019345636,
0.093462564, -0.22773984, 0.0043599787,
0.041617222, -0.083448254, -0.00056920771,
0.0058238031, -0.023986697, -0.012499326,
0.073594868, -0.064767897, -0.010122155,
0.026360201, -0.042808671, 0.022931857,
-0.10084403, 0.00023575520, -0.058728464,
0.095830768, -0.034385771, -0.13739407,
0.032066874, 0.0066194003, 0.022114808,
-0.027390294, 0.0073501850, -0.0030258500,
0.095409028, -0.11319499, 0.013430123,
0.023161361, 0.13742582, -0.16714025,
0.068584681, 0.063569821, -0.063962750,
-0.056474775, 0.16839598, -0.035132650,
-0.10801778, 0.0096693952, 0.0044863992,
0.052297529, -0.060808938, 0.023972575,
0.0023848475, -0.010931749, -0.0014465256,
0.0047543701, -0.12055064, 0.12040976,
0.053391077, -0.066283815, 0.00022211130
};
const float Wo[] = {
0.0062894998, 0.011053815, 0.024437066,
-0.0043050181, 0.057281226, 0.00022245033,
0.029564664, -0.11464067, -0.011823306,
-0.035573807, -0.011592723, -0.030806517,
0.012449744, -0.017784340, -0.013152497,
0.023304399, -0.029480074, 0.0036827496,
-0.021535497, 0.038481198, -0.014154078,
-0.066149779, -0.072418801, -0.060781460,
-0.0028373697, 0.056257986, -0.043182481,
-0.00020178517, 0.0099809747, 0.013117602,
-0.024832005, 0.013203118, -0.0032107276,
0.025593486, 0.065962650, 0.022633363,
0.0012594154, 0.079197697, -0.079808928,
0.059904739, -0.011413852, 0.083101146,
-0.047692824, 0.029802987, 0.026927549,
-0.059390135, 0.030146772, -0.013046196,
0.010435775, -0.025734659, 0.012452380,
-0.00080738403, -0.0080266949, -0.00056450104,
-0.050869063, -0.017681850, 0.056015737,
0.027054112, -0.019066591, -0.028817946
};
const float Wg[] = {
-0.049626015, -0.093100652, -0.037031494,
0.042571083, -0.17520042, 0.035962202,
0.19468853, 0.24414109, -0.022398207,
0.14523810, -0.16808611, 0.033612859,
0.034259718, -0.054838713, -0.074051328,
0.23345011, 0.29670644, 0.020186439,
-0.0063582072, 0.092913039, -0.10280504,
-0.19163576, 0.13546452, -0.010702923,
-0.20457338, 0.045475908, -0.11771677,
0.051694527, -0.087863266, -0.043911561,
-0.14638656, -0.26578858, -0.015354945,
-0.054293551, 0.16972937, 0.027203158,
0.20220429, 0.42485970, -0.012865260,
0.040131185, -0.18734632, 0.15097469,
0.13374907, 0.27371734, 0.068452150,
0.11753921, 0.00062358158, 0.099930525,
0.064181745, 0.086205572, -0.035361923,
0.065173753, 0.094111241, 0.022045940,
0.035333410, 0.032521646, -0.026796810,
0.00016427721, 0.099141642, -0.051770873
};
const float Ri[] =  {
-0.00012863369, 0.0027692916, -0.0044937194, 0.0011528181, -0.0019124795, -0.0044157607, -0.0027408504, -0.0054475549, -0.00081712601, -0.00083135208, 0.0039905249, -0.0017602188, -0.0068715536, 0.0078524612, -0.0028607992, 0.0010374580, -0.0018764377, -2.6624839e-05, -0.0011081693, -0.0014840225,
-0.0014417989, -0.0014910116, 0.0035644670, 0.00065510545, -0.0012519797, -0.0027054125, 0.0044282093, -0.0017971731, 0.0027536119, -0.0036399472, -0.0021356321, 0.0063118637, 0.0065193288, -0.00088195095, 0.0038860731, 0.0017975939, -0.0025569811, -0.0012217602, 0.0052412366, 0.0042586480,
-0.0035761427, 0.0034230023, 0.022145221, -0.0024125187, 0.0042107007, 0.038931593, 0.0037307155, -0.021178631, -0.016290234, -0.00076581485, 0.0025848900, 0.0092527149, 0.021694992, -0.0020298122, 0.0067597311, 0.0070583872, -0.0029174441, -0.00093710952, -0.026149986, 0.0043108058,
-0.0049895123, 0.0072067874, 0.048700105, 0.024926916, 0.0037776486, 0.010254627, -0.0030079661, -0.038194414, -0.025045775, 0.0063220300, -0.0015693698, -0.017427145, 0.016353531, -0.011932581, 0.024998644, 0.0065775099, 0.014223574, 0.0020303284, 0.039294817, -0.0085557867,
0.00044174993, 0.0022172036, -0.0025697052, 0.0017123558, 0.0019612217, -0.0032286420, 0.0019946776, -0.0033637756, 0.0020643149, 0.00035962724, 0.0016328697, 0.00037723052, -0.0044623222, 0.0039471244, -0.0041973731, 0.00087960379, -0.0015353989, -0.0013003600, -0.0017694861, 0.0013067492,
-0.0039773630, -0.023700438, -0.014382360, -0.059459582, -0.0065674069, 0.063759141, -0.00084391615, -0.055990737, -0.016131319, -0.0027432325, -0.0043601613, 0.016972028, 0.028361121, -0.020609161, 0.036203127, -0.013388256, 0.0022536577, -0.0017686164, -0.0081215575, -0.00091145880,
0.0030275369, 0.0070631807, -0.0051987618, 0.0061880276, 0.0030890275, -0.0061379843, -0.0026227275, -0.020860601, -0.0022546570, 0.0021655580, 0.0095219025, -0.0077866632, -0.011828206, 0.0076167937, -0.0078465063, 0.00037480696, -0.0027350835, -0.0028519910, -0.0030349281, -0.0026867699,
-0.0010662861, -0.010350823, 0.025265910, -0.010343112, -0.0040928936, 0.0015348168, -0.0092065409, -0.0019734295, -0.015395002, 0.0046889535, 0.0019189731, -0.014156268, 0.025517924, -0.025200862, 0.028284939, -0.012571394, 0.015247320, 0.0037322748, 0.033000965, -0.012840605,
-0.0060016266, 0.016265126, 0.025421798, 0.032211803, 0.010124647, -0.016327834, 0.0016966270, -0.076498397, -0.028872630, 0.0045672641, 0.0088416860, -0.019526437, -0.0023013172, 0.0088633746, 0.0080512613, 0.015572054, 0.0074619236, -0.0016836355, 0.038090523, -0.0024070807,
-0.0012311311, 0.0019265102, 0.00081848999, 0.00080913870, 0.00070143002, -0.00012272882, 0.00049116323, -2.1961881e-05, 0.0016968576, -0.00068004878, 0.00062450080, 0.00099338801, -0.0059451764, 0.0053234738, -0.0034703889, 0.0022687251, -0.00069796242, 0.00047047221, -0.00084482296, 0.0014409473,
0.0017261097, -0.00057153340, -0.0041719195, -0.0030020531, -0.00071555935, 0.0015315384, 0.00086642004, -0.0055513196, 0.0010701488, -0.0010329885, 0.0017341346, 0.0013662896, -0.00086043158, -0.0016830222, -0.0015206113, -0.0010531629, -0.0019468744, -0.0014739194, -0.0031070972, 0.0013683947,
0.00098105741, 0.013493042, 0.014857101, 0.022751577, 0.0024964949, -0.021122970, -0.012350958, -0.051634002, -0.020141928, 0.0059636626, 0.012214613, -0.025099481, -0.017247213, 0.011777036, 0.0026157415, 0.0068765390, 0.0051238453, -0.00065801787, 0.024332630, -0.013103696,
0.0039314693, -0.0076014153, -0.0032934248, -0.0027074653, -0.0026970259, 0.022355286, 0.0014085703, 0.015107334, -0.0079116309, -0.0011563455, -0.012419472, -0.0066532344, 0.027768910, -0.032224298, 0.015492565, -0.0076557375, 0.0029528388, -2.4867164e-05, -0.0092492690, 0.0011338009,
0.0034711875, -0.0043389215, -0.0035795330, -0.0021900844, -0.0028663832, 0.020109298, 0.00072250678, 0.022198966, 0.0065307706, -0.0041965214, -0.0093403067, 0.0050274641, 0.033917692, -0.018446103, 0.0079993652, -0.0010209749, -0.0046210159, -0.00079016690, -0.017142417, 0.0029819252,
-0.011189041, -0.010181429, 0.037442036, 0.0028134962, 0.010803851, 0.052666031, 0.0026606992, -0.028827360, -0.011787190, -0.0019563430, -0.013868585, 0.0065557719, 0.017179167, -0.0092304489, 0.025415264, 0.0079639964, 0.0048894524, 0.00033856535, 0.038391635, 0.0053766714,
0.00094378262, -0.0050207325, -0.010297783, -0.010923705, -0.0050353319, -0.0085591776, 0.0043869764, 0.010464478, 0.013907663, -0.0081491806, 0.0027820589, 0.011177462, -0.0027020096, 0.0013837967, -0.0011139594, -0.0057920218, -0.0045651933, -0.0026485857, 0.0022652568, 0.0055969087,
-0.0033473696, 0.0048463987, 0.0051611559, 0.0057678097, 0.0039373995, 0.0054611545, 0.0014820449, -0.0048066922, 0.0023323470, 4.4923483e-05, -0.00029215097, 0.00063877110, -0.0072110738, 0.0075985915, -0.0045817723, 0.0049075470, -0.0016932117, -0.00066527264, 8.4593514e-05, 0.0015063054,
-4.2428248e-05, 0.00081951922, -0.00047650890, -0.00033813945, 0.0011036912, -0.00050809520, 0.0010852878, -0.0012073459, 0.0013694089, -4.1855059e-05, 0.00044041217, 0.0012208454, -0.0021920779, 0.0021113772, -0.0020957037, 0.00055872521, -0.00094292709, -0.00077322434, -0.00088953675, 0.00092490262,
-0.0045504649, 0.016705967, 0.0010111145, 0.021306466, -0.0020481406, -0.041678891, -0.012564369, -0.013446745, -0.0015581949, -0.0010961829, 0.015955640, -0.021016650, -0.042147994, 0.026130056, -0.014935778, 0.0037452974, -0.0013813544, -0.0012636899, -0.0063467058, -0.0092650931,
0.0032517607, 0.0059382427, -0.0067368387, 0.0056481427, 0.0052320077, -0.0066635194, -0.00071528769, -0.017432433, -0.00054962392, 0.0026222176, 0.0092592202, -0.0062327539, -0.011593383, 0.0074766087, -0.0097407829, 0.00090058777, -0.0031627400, -0.0030613001, -0.0069391900, -0.0013560004
};
const float Rf[] = {
-0.00013011342,0.0048455270,-0.0074222190,0.0016901849,-0.0032575256,-0.0076536704,-0.0047379592,-0.0086479532,-0.0021392123,-0.0010636818,0.0056937924,-0.0036672249,-0.010824581,0.012489458,-0.0041990280,0.0020666351,-0.0024744421,5.5707227e-05,-0.0023389212,-0.0028195460,
-0.0025852779,-0.0015319104,0.0044031269,0.0020847346,-0.0013927233,-0.0037012859,0.0049364250,-0.0050781672,0.0023721580,-0.0051076142,-0.0027248506,0.0076137865,0.0090600094,-7.4266791e-06,0.0062171421,0.0041335723,-0.0032811398,-0.0014089107,0.0096562561,0.0049595400,
-0.00040015572,0.032940205,0.077125423,0.067546889,-0.0046611167,0.0012141897,-0.069636755,-0.18650217,-0.14475116,0.026264286,0.025856767,-0.10687159,-0.0079819188,0.017116392,0.074299917,0.015912822,0.050332118,0.0085625127,0.089131549,-0.067206308,
-0.0081693120,0.018311627,0.083683416,0.051397230,0.0028444687,0.0071604331,-0.017920587,-0.077086449,-0.054641355,0.012658539,0.00066767615,-0.042789537,0.022911357,-0.015038487,0.047299020,0.015614255,0.028757080,0.0052147168,0.084237881,-0.025055811,
0.0019032178,0.0031813174,-0.0062985192,0.0021866404,0.0032953364,-0.0068076868,0.0025211577,-0.0053728861,0.0036427095,0.00046655140,0.0033127915,0.00065770617,-0.0069843810,0.0062628780,-0.0069732019,0.0011144984,-0.0031156105,-0.0024557281,-0.0037142839,0.0017785068,
-0.0033030428,-0.031982489,0.0095202262,-0.066230804,-0.017866816,0.086950026,-0.047520641,-0.18105605,-0.10100859,0.017997483,-0.0037649614,-0.043173671,0.071253881,-0.034763411,0.11437836,-0.022540998,0.042660490,0.0076452484,0.063577756,-0.047632340,
0.0041410998,0.010411417,-0.0095403716,0.010854922,0.0041941777,-0.0083231973,-0.0034662145,-0.029600304,-0.0028767339,0.0028908402,0.013110414,-0.010630270,-0.018006776,0.011759205,-0.011973916,0.0016258071,-0.0042371145,-0.0038022452,-0.0070208022,-0.0033238388,
-0.0018140021,-0.014786881,0.057465330,-0.0093682585,-0.011962168,-0.010610756,-0.026169827,-0.037177511,-0.042841982,0.0098171197,0.0092979297,-0.037907105,0.039973348,-0.041049771,0.061260249,-0.021912392,0.033052046,0.0081213638,0.087561540,-0.031615637,
-0.013125248,0.021421339,0.086985752,0.050792638,0.011799294,-0.0059335944,-0.0030742052,-0.13860063,-0.068265311,0.0098465979,0.011281111,-0.044497263,0.0091778869,-0.0067210379,0.041888714,0.018810509,0.033483043,0.0046352483,0.088434927,-0.011835586,
-0.0021119770,0.0033587278,0.00099546625,0.0017568872,6.0588536e-06,-0.00085264986,-0.00026109588,-0.0011892618,0.0014098784,-0.00079971255,0.00060841389,3.6100566e-05,-0.0089822486,0.0078342315,-0.0042600571,0.0034458018,-0.00019596124,0.0011185728,-0.0010269583,0.00095554098,
0.0025286688,-0.00064600800,-0.0074891155,-0.0037045658,-0.0011211921,6.9114118e-05,-0.00050755899,-0.011565876,-0.00083975453,-0.00077911263,0.0034971833,-0.00047583901,-0.0022669975,-0.0018667793,-0.0017399658,-0.0020598292,-0.0027768763,-0.0024331582,-0.0051421872,0.00015520932,
0.0011941426,0.022442114,0.031078009,0.039545409,0.0047900216,-0.020608591,-0.021294449,-0.080312423,-0.035228141,0.011478686,0.018051663,-0.042436499,-0.024355531,0.013972943,0.011469400,0.010104766,0.011760676,0.00095683389,0.029708076,-0.023169396,
0.0036258306,-0.025470037,0.0018512253,-0.0083007151,0.0014046106,0.041840561,0.011880392,0.030887954,-0.0078631938,6.4465181e-05,-0.023745224,-0.0079753939,0.050998855,-0.066753738,0.030213870,-0.021443056,0.0060013589,0.00063010590,-0.022890447,0.010478642,
0.0062360205,-0.0057453108,-0.0033495622,0.0023345610,0.0011388644,0.029767197,0.0021007345,0.020251734,0.0044508418,-0.0045568640,-0.015697118,0.0038558526,0.050286356,-0.026352415,0.013094118,0.0030532989,-0.0072339131,-0.0026675942,-0.022114445,0.0046941116,
-0.016766867,-0.017156539,0.058919877,0.014611074,0.013349478,0.065022841,-0.0019539592,-0.066610828,-0.028273940,0.00010944691,-0.011556266,0.0060596010,0.022083499,-0.0061244788,0.041942250,0.0072846184,0.012043394,0.010959642,0.064076610,0.0032238353,
0.0030959533,-0.0041644173,-0.013125503,-0.010692610,-0.0044141901,-0.014224891,0.0027428062,0.0082355877,0.014360895,-0.0088601690,0.0057822764,0.010308176,-0.0032045348,0.0023612152,-0.0024737194,-0.0077738506,-0.0068035969,-0.0048641232,0.0064509232,0.0039265128,
-0.0036786946,0.0090918923,0.011824469,0.012479026,0.0066914372,0.0067194612,-0.0016794691,-0.013682886,-0.0026643591,0.0022352957,0.0017725836,-0.0052708685,-0.012304722,0.012568688,-0.0040886016,0.0078468667,0.00067846040,-0.00063893991,0.0089560989,-0.0025423549,
0.00024130920,0.0013336189,-0.00090648007,1.5999951e-05,0.0016537928,-0.0012090636,0.0012247592,-0.0023648955,0.0015588903,0.00014467606,0.0010589104,0.0011421394,-0.0033660561,0.0031492172,-0.0029594069,0.00075363554,-0.0013991911,-0.0012287616,-0.0012723301,0.00089108763,
0.00026454037,0.033475872,-0.0010327236,0.047316313,-0.013108255,-0.098955832,-0.049839914,-0.071101874,-0.043582849,0.0043957913,0.036884069,-0.071152993,-0.079300091,0.049132898,0.0026990019,0.0055051260,0.014625607,0.0026547725,0.023357347,-0.041258357,
0.0045965407,0.0086163860,-0.011370906,0.0090974271,0.0069654812,-0.010249758,-0.0021041674,-0.024717730,-0.0021838946,0.0042153578,0.013749855,-0.0097823348,-0.018726140,0.013271928,-0.014162353,0.0021469155,-0.0039359932,-0.0039765923,-0.013985183,-0.0029344831
};
const float Ro[] = {
-0.00013011342,0.0048455270,-0.0074222190,0.0016901849,-0.0032575256,-0.0076536704,-0.0047379592,-0.0086479532,-0.0021392123,-0.0010636818,0.0056937924,-0.0036672249,-0.010824581,0.012489458,-0.0041990280,0.0020666351,-0.0024744421,5.5707227e-05,-0.0023389212,-0.0028195460,
-0.0025852779,-0.0015319104,0.0044031269,0.0020847346,-0.0013927233,-0.0037012859,0.0049364250,-0.0050781672,0.0023721580,-0.0051076142,-0.0027248506,0.0076137865,0.0090600094,-7.4266791e-06,0.0062171421,0.0041335723,-0.0032811398,-0.0014089107,0.0096562561,0.0049595400,
-0.00040015572,0.032940205,0.077125423,0.067546889,-0.0046611167,0.0012141897,-0.069636755,-0.18650217,-0.14475116,0.026264286,0.025856767,-0.10687159,-0.0079819188,0.017116392,0.074299917,0.015912822,0.050332118,0.0085625127,0.089131549,-0.067206308,
-0.0081693120,0.018311627,0.083683416,0.051397230,0.0028444687,0.0071604331,-0.017920587,-0.077086449,-0.054641355,0.012658539,0.00066767615,-0.042789537,0.022911357,-0.015038487,0.047299020,0.015614255,0.028757080,0.0052147168,0.084237881,-0.025055811,
0.0019032178,0.0031813174,-0.0062985192,0.0021866404,0.0032953364,-0.0068076868,0.0025211577,-0.0053728861,0.0036427095,0.00046655140,0.0033127915,0.00065770617,-0.0069843810,0.0062628780,-0.0069732019,0.0011144984,-0.0031156105,-0.0024557281,-0.0037142839,0.0017785068,
-0.0033030428,-0.031982489,0.0095202262,-0.066230804,-0.017866816,0.086950026,-0.047520641,-0.18105605,-0.10100859,0.017997483,-0.0037649614,-0.043173671,0.071253881,-0.034763411,0.11437836,-0.022540998,0.042660490,0.0076452484,0.063577756,-0.047632340,
0.0041410998,0.010411417,-0.0095403716,0.010854922,0.0041941777,-0.0083231973,-0.0034662145,-0.029600304,-0.0028767339,0.0028908402,0.013110414,-0.010630270,-0.018006776,0.011759205,-0.011973916,0.0016258071,-0.0042371145,-0.0038022452,-0.0070208022,-0.0033238388,
-0.0018140021,-0.014786881,0.057465330,-0.0093682585,-0.011962168,-0.010610756,-0.026169827,-0.037177511,-0.042841982,0.0098171197,0.0092979297,-0.037907105,0.039973348,-0.041049771,0.061260249,-0.021912392,0.033052046,0.0081213638,0.087561540,-0.031615637,
-0.013125248,0.021421339,0.086985752,0.050792638,0.011799294,-0.0059335944,-0.0030742052,-0.13860063,-0.068265311,0.0098465979,0.011281111,-0.044497263,0.0091778869,-0.0067210379,0.041888714,0.018810509,0.033483043,0.0046352483,0.088434927,-0.011835586,
-0.0021119770,0.0033587278,0.00099546625,0.0017568872,6.0588536e-06,-0.00085264986,-0.00026109588,-0.0011892618,0.0014098784,-0.00079971255,0.00060841389,3.6100566e-05,-0.0089822486,0.0078342315,-0.0042600571,0.0034458018,-0.00019596124,0.0011185728,-0.0010269583,0.00095554098,
0.0025286688,-0.00064600800,-0.0074891155,-0.0037045658,-0.0011211921,6.9114118e-05,-0.00050755899,-0.011565876,-0.00083975453,-0.00077911263,0.0034971833,-0.00047583901,-0.0022669975,-0.0018667793,-0.0017399658,-0.0020598292,-0.0027768763,-0.0024331582,-0.0051421872,0.00015520932,
0.0011941426,0.022442114,0.031078009,0.039545409,0.0047900216,-0.020608591,-0.021294449,-0.080312423,-0.035228141,0.011478686,0.018051663,-0.042436499,-0.024355531,0.013972943,0.011469400,0.010104766,0.011760676,0.00095683389,0.029708076,-0.023169396,
0.0036258306,-0.025470037,0.0018512253,-0.0083007151,0.0014046106,0.041840561,0.011880392,0.030887954,-0.0078631938,6.4465181e-05,-0.023745224,-0.0079753939,0.050998855,-0.066753738,0.030213870,-0.021443056,0.0060013589,0.00063010590,-0.022890447,0.010478642,
0.0062360205,-0.0057453108,-0.0033495622,0.0023345610,0.0011388644,0.029767197,0.0021007345,0.020251734,0.0044508418,-0.0045568640,-0.015697118,0.0038558526,0.050286356,-0.026352415,0.013094118,0.0030532989,-0.0072339131,-0.0026675942,-0.022114445,0.0046941116,
-0.016766867,-0.017156539,0.058919877,0.014611074,0.013349478,0.065022841,-0.0019539592,-0.066610828,-0.028273940,0.00010944691,-0.011556266,0.0060596010,0.022083499,-0.0061244788,0.041942250,0.0072846184,0.012043394,0.010959642,0.064076610,0.0032238353,
0.0030959533,-0.0041644173,-0.013125503,-0.010692610,-0.0044141901,-0.014224891,0.0027428062,0.0082355877,0.014360895,-0.0088601690,0.0057822764,0.010308176,-0.0032045348,0.0023612152,-0.0024737194,-0.0077738506,-0.0068035969,-0.0048641232,0.0064509232,0.0039265128,
-0.0036786946,0.0090918923,0.011824469,0.012479026,0.0066914372,0.0067194612,-0.0016794691,-0.013682886,-0.0026643591,0.0022352957,0.0017725836,-0.0052708685,-0.012304722,0.012568688,-0.0040886016,0.0078468667,0.00067846040,-0.00063893991,0.0089560989,-0.0025423549,
0.00024130920,0.0013336189,-0.00090648007,1.5999951e-05,0.0016537928,-0.0012090636,0.0012247592,-0.0023648955,0.0015588903,0.00014467606,0.0010589104,0.0011421394,-0.0033660561,0.0031492172,-0.0029594069,0.00075363554,-0.0013991911,-0.0012287616,-0.0012723301,0.00089108763,
0.00026454037,0.033475872,-0.0010327236,0.047316313,-0.013108255,-0.098955832,-0.049839914,-0.071101874,-0.043582849,0.0043957913,0.036884069,-0.071152993,-0.079300091,0.049132898,0.0026990019,0.0055051260,0.014625607,0.0026547725,0.023357347,-0.041258357,
0.0045965407,0.0086163860,-0.011370906,0.0090974271,0.0069654812,-0.010249758,-0.0021041674,-0.024717730,-0.0021838946,0.0042153578,0.013749855,-0.0097823348,-0.018726140,0.013271928,-0.014162353,0.0021469155,-0.0039359932,-0.0039765923,-0.013985183,-0.0029344831
};
const float Rg[] = {0.55528 , 2.5318 , 0.1638 , -1.6068 , 2.0541 , -1.3504 , 1.676 , 1.6243 , 0.026693 , -0.1308 , 0.20392 , -0.091063 , 0.70342 , -1.2232 , 0.68257 , -0.20124 , 0.79894 , 0.79979 , -0.3251 , -0.14942 , -0.24052 , 0.6494 , -1.0478 , -0.02468 , 0.45816 , -1.0718 , -1.0864 , 1.1435 , -1.0711 , 0.59964 , 0.10115 , -1.9683 , 1.0385 , 0.59852 , -0.73537 , 0.19994 , 0.68398 , 0.24606 , 0.29749 , 0.66329 , -0.20516 , 1.1004 , -0.57669 , -1.6861 , -0.50723 , -0.1925 , -1.3566 , -1.0383 , 0.25129 , -0.050611 , -0.14331 , 0.16408 , -0.55444 , -1.4197 , -0.061528 , -0.086922 , -1.4831 , -1.9808 , 0.72859 , 0.52937 , -0.1785 , -0.73015 , 1.392 , 1.7854 , -0.29294 , -0.20364 , 0.72559 , 0.30739 , -0.10649 , 0.36294 , 0.60719 , -2.2171 , 0.50773 , 0.32699 , 0.30675 , -0.58771 , 1.1802 , 0.017913 , -1.2273 , 0.33755 , 0.24526 , 0.70395 , -0.82829 , 0.10742 , -0.3099 , 0.75299 , -0.53718 , 0.25904 , 0.3774 , 0.10035 , 0.19093 , 1.067 , 0.14579 , -0.7526 , 2.8876 , 0.43891 , -0.39437 , -1.1537 , -0.22893 , -0.87183 , 0.99157 , 0.87636 , -0.73482 , 0.33294 , -1.1181 , -0.016917 , 0.91914 , -0.040993 , -0.26974 , -0.40787 , -0.53622 , -0.78792 , 0.60345 , 0.70069 , 0.78838 , -0.073484 , -0.59694 , -0.44166 , 0.40579 , 0.36431 , -0.08813 , -1.2879 , 1.439 , -0.34434 , -0.79289 , 0.65202 , -1.9654 , 1.0478 , -0.67949 , 1.7013 , 1.9162 , -0.7637 , 0.0080293 , 0.083578 , -0.5111 , 0.64762 , 0.93082 , 0.17853 , -1.9555 , 2.0589 , 0.95505 , -0.030569 , -2.4557 , 0.54952 }; 
const float bi[] = {-0.67298 , 0.93189 , -0.35789 , 0.2021 , 0.87625 , 0.80795 , -1.6033 , -2.3621 , -0.7017 , 1.6519 , 0.23507 , -0.15175 }; 
const float bf[] = {0.12185 , -1.238 , 0.24413 , 1.3983 , -0.095473 , 0.38762 , -0.96631 , 1.5092 , 0.40383 , -0.42214 , -1.674 , -0.68763 }; 
const float bo[] = {-0.15589 , 1.0382 , 0.33048 , 0.47581 , -2.0905 , -0.17403 , 0.019188 , -0.86003 , -0.022949 , -0.60232 , 0.8699 , -0.57081 }; 
const float bg[] = {-1.0272 , -0.49256 , 0.34681 , 0.82935 , 0.15563 , 0.083714 , 0.37462 , 2.6532 , 0.33271 , 0.14077 , 1.5778 , 0.089548 }; 
const float WFC[] = {1.3047 , -0.042644 , 0.89553 , 2.2849 , 0.066827 , 1.4946 , -1.0725 , 1.8233 , -1.2084 , -0.065392 , -0.32684 , -1.1492 };
const float bFC = {-1.308};
const float MOY[] = {0.10982 , -1.6547 , 1.1107 };
const float ECART_TYPE[] = {2.8921 , 4.4502 , 5.0943 };

  // variables intermédiaires : pas d'initialisation
  float it[tailleReseau];
  float ft[tailleReseau];
  float gt[tailleReseau];
  float ot[tailleReseau];


  // Aurore : Les tableaux sont des const float, donc les pointeurs aussi (rajout du const)
  // Aurore : enlever les {} qui entouraient les pointeurs
  // définition des pointeurs
  float *pointeur_ht = &ht[0];
  float *pointeur_ct = &ct[0];
  float *pointeur_xt = &xt[0];
  float *pointeur_it = &it[0];
  float *pointeur_ft = &ft[0];
  float *pointeur_gt = &gt[0];
  float *pointeur_ot = &ot[0];
  const float *pointeur_Wi =  &Wi[0];
  const float *pointeur_Wf =  &Wf[0];
  const float *pointeur_Wg =  &Wg[0];
  const float *pointeur_Wo =  &Wo[0];
  const float *pointeur_Ri =  &Ri[0];
  const float *pointeur_Rf =  &Rf[0];
  const float *pointeur_Rg =  &Rg[0];
  const float *pointeur_Ro =  &Ro[0];
  const float *pointeur_bi =  &bi[0];
  const float *pointeur_bf =  &bf[0];
  const float *pointeur_bg = &bg[0];
  const float *pointeur_bo = &bo[0];
  const float *pointeur_WFC =  &WFC[0] ;
  const float *pointeur_bFC =  &bFC ;
  const float *pointeur_MOY =  &MOY[0] ;
  const float *pointeur_ECART_TYPE = &ECART_TYPE[0];

  // vecteurs intermédiaires
  float vect_intermediaire_1[tailleReseau];
  float *pointeur_vect_intermediaire_1 =  &vect_intermediaire_1[0] ;
  float vect_intermediaire_2[tailleReseau];
  float *pointeur_vect_intermediaire_2 =  &vect_intermediaire_2[0] ;

  // variables de sortie
  float sortie_LSTM;
  float *pointeur_sortie_LSTM =  &sortie_LSTM ;

  // filtre de Kalman
  const float dt = 1;
  const float moins_eta_sur_Q = 0.00023003;
  float Pk = 1;
  float *pointeur_Pk =  &Pk; 
  float *pointeur_SOC =  &SOC ; 
  const float Qk = 0.000001;
  const float Rk = 1;
  // Fk et Hk ne sont pas définies car elles valent 1 et sont multiplicatives

  // mesure de temps
  unsigned long tempsInitial;
  unsigned long tempsFinal;
  float bilanTempsLSTM;
  float bilanTempsFdK;
  const int NbIteration = 10;
  int z;

  // initialisation de la communication pour les résultats
  // Serial.begin(9600);
  printf("");
  printf("");

  // simulation
  // Aurore : Mesure du temps de simulation, a régler plus tard
  // tempsInitial = micros();
  for (z = 0; z <= NbIteration - 1; z++) {
    printf("%f\n", *(pointeur_SOC));
    estimationSOC(courant, tension, temperature, SOH, moins_eta_sur_Q, pointeur_Pk, pointeur_SOC,
                    dt, Qk, Rk, tailleEntree, tailleReseau, tailleSortie, pointeur_sortie_LSTM,
                   pointeur_xt, pointeur_ct, pointeur_ht,
                   pointeur_it, pointeur_ft, pointeur_gt, pointeur_ot,
                   pointeur_Wi, pointeur_Wf, pointeur_Wg, pointeur_Wo,
                   pointeur_Ri, pointeur_Rf, pointeur_Rg, pointeur_Ro,
                   pointeur_bi, pointeur_bf, pointeur_bg, pointeur_bo,
                   pointeur_MOY, pointeur_ECART_TYPE, pointeur_WFC, pointeur_bFC,
                   pointeur_vect_intermediaire_1, pointeur_vect_intermediaire_2);

  
    printf("%f\n", *(pointeur_SOC));
  }
  // Aurore : A regler plus tard
  //tempsFinal = micros();
 // bilanTempsLSTM = (tempsFinal - tempsInitial) / NbIteration;

  // affichage des résultats
  printf("Sortie : ");
  printf("%f\n", *(pointeur_SOC) *1000);
  //printf("Bilan (ms) : ");
  //printf(bilanTempsLSTM / 1000);
  printf("");
}

// Aurore : fonction loop inutile
// void loop() {
//   // put your main code here, to run repeatedly:
// }

void estimationSOC(float courant, float tension, float temperature, float SOH, const float moins_eta_sur_Q, float *pointeur_Pk, float *pointeur_SOC,
                   const float dt, const float Qk, const float Rk, int tailleEntree, int tailleReseau, int tailleSortie, float *pointeur_sortie_LSTM,
                   float *pointeur_xt, float *pointeur_ct, float *pointeur_ht,
                   float *pointeur_it, float *pointeur_ft, float *pointeur_gt, float *pointeur_ot,
                   const float *pointeur_Wi,const float *pointeur_Wf,const float *pointeur_Wg,const float *pointeur_Wo,
                   const float *pointeur_Ri,const float *pointeur_Rf,const float *pointeur_Rg,const float *pointeur_Ro,
                   const float *pointeur_bi,const float *pointeur_bf,const float *pointeur_bg,const float *pointeur_bo,
                   const float *pointeur_MOY,const float *pointeur_ECART_TYPE,const float *pointeur_WFC,const float *pointeur_bFC,
                   float *pointeur_vect_intermediaire_1, float *pointeur_vect_intermediaire_2) {

float Sk;
float Kk;
  float residus;
  float prediction_LSTM;
  float SOC = *pointeur_SOC;
  SOC = SOC - moins_eta_sur_Q * dt * courant / SOH;
  *(pointeur_xt) = courant;
  *(pointeur_xt + 1) = tension;
  *(pointeur_xt + 2) = temperature;

  predictionLSTM(tailleEntree, tailleReseau, tailleSortie, pointeur_sortie_LSTM, pointeur_xt, pointeur_ct, pointeur_ht,
                 pointeur_it, pointeur_ft, pointeur_gt, pointeur_ot,
                 pointeur_Wi, pointeur_Wf, pointeur_Wg, pointeur_Wo,
                 pointeur_Ri, pointeur_Rf, pointeur_Rg, pointeur_Ro,
                 pointeur_bi, pointeur_bf, pointeur_bg, pointeur_bo,
                 pointeur_MOY, pointeur_ECART_TYPE, pointeur_WFC, pointeur_bFC,
                 pointeur_vect_intermediaire_1, pointeur_vect_intermediaire_2);
  prediction_LSTM = *pointeur_sortie_LSTM;
  prediction_LSTM = min(max(prediction_LSTM, 0), 1);
  *(pointeur_Pk) = *(pointeur_Pk) + Qk;  // on néglige Fk = 1
  residus = prediction_LSTM - SOC;
  Sk = *(pointeur_Pk) + Rk;  // on néglige Hk = 1;
  Kk = *(pointeur_Pk) / Sk;
  SOC = SOC + Kk * residus;
  SOC = min(max(SOC, 0), 1);
  *(pointeur_Pk) = (1 - Kk) * *(pointeur_Pk);
  *(pointeur_SOC) = SOC;
}

void predictionLSTM(int tailleEntree, int tailleReseau, int tailleSortie, float *pointeur_sortie_LSTM, float *pointeur_xt, float *pointeur_ct, float *pointeur_ht,
                    float *pointeur_it, float *pointeur_ft, float *pointeur_gt, float *pointeur_ot,
                    const float *pointeur_Wi,const float *pointeur_Wf,const float *pointeur_Wg,const float *pointeur_Wo,
                    const float *pointeur_Ri,const float *pointeur_Rf,const float *pointeur_Rg,const float *pointeur_Ro,
                    const float *pointeur_bi,const float *pointeur_bf,const float *pointeur_bg,const float *pointeur_bo,
                    const float *pointeur_MOY,const float *pointeur_ECART_TYPE,const float *pointeur_WFC,const float *pointeur_bFC,
                    float *pointeur_vect_intermediaire_1, float *pointeur_vect_intermediaire_2) {


  int i;

  // mise en forme de l'entrée
  for (i = 0; i <= tailleEntree - 1; i++) {
    *(pointeur_xt + i) = (*(pointeur_xt + i) - *(pointeur_MOY + i)) / *(pointeur_ECART_TYPE + i);
  }

  // calcul de it
  MatriceFoisVecteur(tailleReseau, tailleEntree, pointeur_Wi, pointeur_xt, pointeur_vect_intermediaire_1);
  MatriceFoisVecteur(tailleReseau, tailleReseau, pointeur_Ri, pointeur_ht, pointeur_vect_intermediaire_2);
  for (i = 0; i <= tailleReseau - 1; i++) {
    *(pointeur_it + i) = *(pointeur_vect_intermediaire_1 + i) + *(pointeur_vect_intermediaire_2 + i) + *(pointeur_bi + i);
  }
  sigma_g_sigmoide(tailleReseau, pointeur_it, pointeur_it);

  // calcul de ft
  MatriceFoisVecteur(tailleReseau, tailleEntree, pointeur_Wf, pointeur_xt, pointeur_vect_intermediaire_1);
  MatriceFoisVecteur(tailleReseau, tailleReseau, pointeur_Rf, pointeur_ht, pointeur_vect_intermediaire_2);
  for (i = 0; i <= tailleReseau - 1; i++) {
    *(pointeur_ft + i) = *(pointeur_vect_intermediaire_1 + i) + *(pointeur_vect_intermediaire_2 + i) + *(pointeur_bf + i);
  }
  sigma_g_sigmoide(tailleReseau, pointeur_ft, pointeur_ft);

  // calcul de gt
  MatriceFoisVecteur(tailleReseau, tailleEntree, pointeur_Wg, pointeur_xt, pointeur_vect_intermediaire_1);
  MatriceFoisVecteur(tailleReseau, tailleReseau, pointeur_Rg, pointeur_ht, pointeur_vect_intermediaire_2);
  for (i = 0; i <= tailleReseau - 1; i++) {
    *(pointeur_gt + i) = *(pointeur_vect_intermediaire_1 + i) + *(pointeur_vect_intermediaire_2 + i) + *(pointeur_bg + i);
  }
  sigma_c_tanh(tailleReseau, pointeur_gt, pointeur_gt);

  // calcul de ot
  MatriceFoisVecteur(tailleReseau, tailleEntree, pointeur_Wo, pointeur_xt, pointeur_vect_intermediaire_1);
  MatriceFoisVecteur(tailleReseau, tailleReseau, pointeur_Ro, pointeur_ht, pointeur_vect_intermediaire_2);
  for (i = 0; i <= tailleReseau - 1; i++) {
    *(pointeur_ot + i) = *(pointeur_vect_intermediaire_1 + i) + *(pointeur_vect_intermediaire_2 + i) + *(pointeur_bo + i);
  }
  sigma_g_sigmoide(tailleReseau, pointeur_ot, pointeur_ot);

  // calcul de ct
  for (i = 0; i <= tailleReseau - 1; i++) {
    *(pointeur_ct + i) = *(pointeur_ft + i) * *(pointeur_ct + i) + *(pointeur_it + i) * *(pointeur_gt + i);
  }

  // calcul de ht
  sigma_c_tanh(tailleReseau, pointeur_ct, pointeur_ht);
  for (i = 0; i <= tailleReseau - 1; i++) {
    *(pointeur_ht + i) = *(pointeur_ot + i) * *(pointeur_ht + i);
  }

  // calcul de la sortie
  MatriceFoisVecteur(tailleSortie, tailleReseau, pointeur_WFC, pointeur_ht, pointeur_vect_intermediaire_1);
  *(pointeur_sortie_LSTM) = *(pointeur_vect_intermediaire_1) + *pointeur_bFC;
}

void sigma_g_sigmoide(int x_size, float *pointeur_entree, float *pointeur_sortie_sig) {

  int i;

  for (i = 0; i <= x_size - 1; i++) {
    *(pointeur_sortie_sig + i) = 1 / (1 + exp(-*(pointeur_entree + i)));
  }
}

void sigma_c_tanh(int x_size, float *pointeur_entree, float *pointeur_sortie_tanh) {

  int i;

  for (i = 0; i <= x_size - 1; i++) {
    *(pointeur_sortie_tanh + i) = tanh(*(pointeur_entree + i));
  }
}


void MatriceFoisVecteur(int nbLignesMatrice, int tailleVecteur, const float *pointeur_matrice, float *pointeur_vecteur, float *pointeur_sortie_prodMat) {
  // définition des variables
  int i;
  int j;
  float resultat_tmp;


  for (i = 0; i <= nbLignesMatrice - 1; i++) {
    resultat_tmp = 0;
    for (j = 0; j <= tailleVecteur - 1; j++) {
      resultat_tmp += *(pointeur_matrice + j + i * tailleVecteur) * *(pointeur_vecteur + j);
    }
    *(pointeur_sortie_prodMat + i) = resultat_tmp;
  }
}

// Aurore : Rajout du main, sinon ça fonctionne pas

int main() {
    setup();
    printf("Fin du programme\n");
}